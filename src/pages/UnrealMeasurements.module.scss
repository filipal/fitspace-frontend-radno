@use '../styles' as s;
$design-w: 430; /* jedan izvor istine */

@function cqw($px, $base: $design-w) {
  @return calc((#{$px} / #{$base}) * 100cqw); 
}

@function fsz($n, $minFactor: .85) {
  @return clamp(#{$n * $minFactor}px, cqw(#{$n}), #{$n}px);
}

:root {
  --design-w: #{$design-w};
  --design-h: 932;   /* visina dizajna (broj, bez px) */
  --header-h: 101;   /* visina headera (broj, bez px); stavi 0 ako ga nema */
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
}
.page {
  /* omogućuje cqw mjere u odnosu na širinu ove stranice */
  container-type: inline-size;
  position: relative;   /* ⟵ referenca za apsolutno pozicioniranje */
  width: 100%;
  max-width: 100%;
  min-height: 100dvh;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  color: #000;
  background: #ececec;
  --page-w-px: 100cqw;
  container-name: page;
  /* nasljeđivanje fonta i na form-kontrole */
  button, input, select, textarea { font: inherit; }
}

.centralWrapper {
  --acc-h: 0;
  --acc-gap: 0px;
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
  height: var(--avatar-h);
}

/* Kada je accordion otvoren, smanji središnje područje za visinu accordeona */
.withAccordion { height: calc(var(--avatar-h) - var(--acc-h, 0)); }

/* Per-accordion visine na 430 baseline (skaliraju kroz cqw) */
.accBody   { --acc-h: cqw(171); }
.accFace   { --acc-h: cqw(80); }
.accSkin   { --acc-h: cqw(60); }
.accHair   { --acc-h: cqw(120); }
.accExtras { --acc-h: cqw(120); }

.avatarSection {
  width: 100%;
  height: 100%;
  max-width: 100%;
  position: relative;
  display: flex;
  justify-content: center;
  align-items: flex-end;
  background: #ADADAC;
}

.avatarButton {
  inline-size: min(calc((30 / 430) * var(--page-w-px)), 30px);
  height: min(calc((19 / 430) * var(--page-w-px)), 19px);
  block-size: min(calc((19 / 430) * var(--page-w-px)), 19px);
  padding: 0;
  border: 0;
  background: transparent;
  display: grid;
  place-items: center;
  flex: 0 0 auto; /* ne rasteži u header flexu */
}
.avatarButton img{
  inline-size: 100%;
  block-size:  100%;
  object-fit: contain;
  display: block;
}

/* osiguraj minimalni tap-target na manjim širinama */
@container page (max-width: 400px){
  .avatarButton{
    min-inline-size: 28px;
    min-block-size:  28px;
  }
}

/* —— DATA PANEL POZICIJA I DIMENZIJE —— */
/* Wrapper određuje točnu kutiju 180×495 i poziciju 10/10 od stranice */
.dataPanelWrapper {
  position: absolute;
  /* 10px ispod headera (realna visina), skalirano po širini stranice */
  top: calc(
    var(--header-real-h, calc(var(--header-h, 0) * 1px))
    + (10 / 430) * var(--page-w-px)
  );
  left: calc((10 / 430) * var(--page-w-px));
  inline-size: calc((180 / 430) * var(--page-w-px));
  /* Ograniči visinu na (avatar-h − controlGroupVisina − njegov bottom offset − 2px gap) */
  block-size:  min(
    calc((495 / 430) * var(--page-w-px)),
    calc(var(--avatar-h) - var(--ctrl-h, #{cqw(60)}) - var(--ctrl-bottom, #{cqw(10)}) - 10px)
  );
  max-block-size: calc(var(--avatar-h) - var(--ctrl-h, #{cqw(60)}) - var(--ctrl-bottom, #{cqw(10)}) - 2px);
  overflow: hidden;
  z-index: 2;
}

.bodySelected {
  height: min(var(--avatar-h), cqw(579));
  justify-content: flex-end;
}

@container page (max-width: 400px){
  .dataPanelWrapper{
    /* umjesto +10px (skalirano), koristi +6px (skalirano) */
    top: calc(var(--header-h, 0) * 1px + (-3 / 430) * var(--page-w-px));
    /* po želji: i lijevi odmak mrvu manji */
    /* left: calc((8 / 430) * var(--page-w-px)); */
  }
}

/* Background strip behind DataPanel when Body is selected */
.bodySelected::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  width: cqw(156);
  background: #BAB9BA;
  z-index: 0; /* stays behind DataPanel (which gets z-index:1) */
  pointer-events: none; /* do not block interactions */
}

.bodySelected .avatarImage {
  width: cqw(274);
  height: min(var(--avatar-h), cqw(579));
}

.avatarImage {
/*   width: 100%;
  height: 100%;
  object-fit: contain; */
  height: 100%;
  width: auto;
  max-width: 100%;
  object-fit: contain;
}

/* Face mode: show top-cropped/zoomed view at 430x670 */
.faceSelected {
  height: min(var(--avatar-h), cqw(670));
  --avatar-zoom: 2.4;
  overflow: hidden;
}

.faceSelected .avatarImage {
  width: 100%;
  height: 100%;
  object-fit: cover;
  object-position: top center;
  transform: scale(var(--avatar-zoom, 1));
  transform-origin: top center;
  will-change: transform;
}

/* Skin mode */
.skinSelected {
  height: min(var(--avatar-h), cqw(690));
  overflow: hidden;
  --avatar-zoom: 1.0;
  background: #BAB9BA;
}

.skinSelected .avatarImage {
  width: 100%;
  height: 100%;
  object-fit: contain; /* keep full body */
  transform: scale(var(--avatar-zoom, 1));
  transform-origin: center bottom;
}

/* Hair mode */
.hairSelected {
  height: min(var(--avatar-h), cqw(630));
  overflow: hidden;
  --avatar-zoom: 2.4;
}

.hairSelected .avatarImage {
  width: 100%;
  height: 100%;
  object-fit: cover; /* match Face behavior */
  object-position: top center; /* focus on the top area */
  transform: scale(var(--avatar-zoom, 1));
  transform-origin: top center;
  will-change: transform;
}

/* Extras mode */
.extrasSelected {
  height: min(var(--avatar-h), cqw(630));
  overflow: hidden;
  --avatar-zoom: 2.4;
}

.extrasSelected .avatarImage {
  width: 100%;
  height: 100%;
  object-fit: cover;
  object-position: top center;
  transform: scale(var(--avatar-zoom, 1));
  transform-origin: top center;
  will-change: transform;
}

.accordion {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  border-radius: 0 !important;
  -webkit-text-size-adjust: none;
  text-size-adjust: none;
}

/* Kontrole ispod avatara */
.controlGroup {
  position: absolute;
  bottom: cqw(10);
  left: 50%;
  transform: translateX(-50%);
  width: cqw(410);
  height: cqw(60);
  display: flex;
  align-items: flex-end;
  z-index: 3;
}

.controlButton {
  position: relative;
  border: none;
  padding: 0;
  background: none;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: all 0.2s ease;
  color: #FFFFFF;
}
.controlButton svg { display: block; }
.controlButton svg .outerHalo { transition: fill .2s ease; }
.controlButton.selected svg .outerHalo { fill: #000; fill-opacity: 1; }
.controlButton svg .whiteRing { shape-rendering: geometricPrecision; }

.controlIcon {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

.controlButton .outerCircle { display: none; }
.controlButton.selected { color: #FFFFFF; }

.controlIcon { position: relative; z-index: 2; }
.outerCircle {
  position: absolute;
  inset: 0;
  border-radius: 50%;
  border: cqw(2) solid #FFFFFF;
  background: transparent;
  box-sizing: border-box;
  transition: border-color .25s ease;
  z-index: 1;
  pointer-events: none;
}
.controlButton.selected .outerCircle { border-color: #000; }

/* pojedinačne širine/razmaci ikona */
.rotateleft  { width: cqw(60); margin-right: cqw(50); }
.upload      { width: cqw(50); margin-right: cqw(25); }
.fullscreen  { width: cqw(40); margin-right: cqw(25); }
.download    { width: cqw(50); margin-right: cqw(50); }
.rotateright { width: cqw(60); }

/* Bottom nav sekcija */
.bottomSection {
  width: 100%;
  max-width: none;
  --nav-scale: clamp(.75, calc(var(--page-w-px) / 430px), 2);
  --nav-size: calc(60px * var(--nav-scale));
  --nav-gap: calc(10px * var(--nav-scale));
  --nav-track: calc(5px * var(--nav-scale));
  --nav-label-h: clamp(18px, calc(20px * min(var(--nav-scale), 1)), 32px);
  --nav-label-font: clamp(12px, calc(14px * min(var(--nav-scale), 1.1)), 20px);
  --nav-icon-target: calc(31px * var(--nav-scale));
  --nav-icon-max: calc(var(--nav-size) - var(--nav-track) - var(--nav-label-h) - 4px);
  --nav-icon-h: clamp(16px, min(var(--nav-icon-target), var(--nav-icon-max)), calc(var(--nav-size) * .68));
  --nav-icon-w: clamp(24px, calc(var(--nav-icon-h) * 1.35), calc(var(--nav-size) * .85));
  --nav-icon-gap: clamp(2px, calc(2px * var(--nav-scale)), 8px);
  height: calc(var(--nav-size) + max(env(safe-area-inset-bottom, 0px), calc(21px * var(--nav-scale))));
  border-top: 1px solid #000; /* border ostavi 1px zbog oštrine */
  display: flex;
  justify-content: center;
  align-items: flex-end;
  padding-top: 0; /* Uklanja padding da border bude flush */
  background: #ececec;
  position: relative;
}

.bottomNav {
  width: 100%;
  max-width: calc(410px * var(--nav-scale));
  height: var(--nav-size);
  display: flex;
  align-self: flex-start; /* poravnaj uz gornji rub roditelja */
}

.navButton {
  width: var(--nav-size);
  height: var(--nav-size);
  padding: 0;
  border: none;
  background: none;
  /* -webkit-appearance: none;  iOS: ne bojaj tekst kao link/gumb */
  color: #000;              /* fiksiraj boju teksta na iOS-u */
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-end; /* Poravnava sadržaj po dnu */
  position: relative; /* Allows absolute-positioned top indicator */
}

.navButton:not(:first-child) {
  margin-left: var(--nav-gap);
}

.navIndicator {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: var(--nav-track);
  display: none;
}

.active .navIndicator {
  background: #000;
  display: block;
}

.navIcon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: var(--nav-icon-w);
  height: var(--nav-icon-h);
  order: 2; /* Stavlja ikonu u sredinu */
  margin-bottom: var(--nav-icon-gap);
}

.navIcon img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  object-position: center;
}

.navLabel {
  height: var(--nav-label-h);
  font-size: var(--nav-label-font);
  color: inherit;           /* naslijedi crnu iz .navButton */
  white-space: nowrap;      /* izbjegni lom teksta u širinu */
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;  /* zaštita od prelijevanja (crveni outline) */
  display: flex;
  align-items: center;
  justify-content: center;
  order: 3; /* Stavlja label na dno */
}

@include s.respond(tablet-xxl) {
  .page {
    width: 100vw;
    max-width: none;
    margin-left: calc(50% - 50vw);
    height: 100svh;
    align-items: flex-start;
    position: relative;
  }
  .centralWrapper {
    flex-direction: row;
    align-items: flex-start;
    justify-content: center;
    width: calc(100vw - 90px - var(--acc-w, 0px));
    max-width: none;
    height: calc(100vh - var(--header-real-h, 71px));
    padding-right: 0;
    --panel-scale: clamp(0, calc(var(--avatar-h, 953px) / 953px), 1);
    --desktop-gap-scale: clamp(0, calc((100vw - 90px - var(--acc-w, 0px)) / 1015px), 1);
  }
  .centralWrapper.withAccordion {
    justify-content: flex-start;
    gap: clamp(15px, calc(24px * var(--desktop-gap-scale, 1)), 24px);
  }
  .accBody   { --acc-w: 335px; --acc-gap: 24px; }
  .accFace   { --acc-w: 187px; --acc-gap: 0px; }
  .accSkin   { --acc-w: 117px; --acc-gap: 0px; }
  .accHair   { --acc-w: 187px; --acc-gap: 0px; }
  .accExtras { --acc-w: 187px; --acc-gap: 0px; }
  .accBody   + .accordion { width: 335px; }
  .accFace   + .accordion { width: 187px; }
  .accSkin   + .accordion { width: 117px; }
  .accHair   + .accordion { width: 187px; }
  .accExtras + .accordion { width: 187px; }
  .avatarShifted { margin-left: clamp(20px, calc(123px * var(--desktop-gap-scale, 1)), 123px); }
/*   .avatarSection { width: 604px; height: 953px; } */
  .avatarSection {
    flex: 1 1 auto;
    min-width: 410px;
    max-width: 604px;
    height: 100%;
  }
  .controlGroup {
    width: 410px;
    height: 60px;
    bottom: 10px;
  }
  .rotateleft {
    width: 60px;
    height: 60px;
    margin-right: 50px;
  }
  .upload {
    width: 50px;
    height: 50px;
    margin-right: 25px;
  }
  .fullscreen {
    width: 40px;
    height: 40px;
    margin-right: 25px;
  }
  .download {
    width: 50px;
    height: 50px;
    margin-right: 50px;
  }
  .rotateright {
    width: 60px;
    height: 60px;
  }
  .outerCircle {
    border-width: 2px;
  }

  .bodySelected { height: min(var(--avatar-h), 953px); justify-content: center; }
  .bodySelected::before { display: none; }
  .bodySelected .avatarImage { width: auto; height: 100%; max-height: var(--avatar-h); }
  .dataPanelWrapper {
    position: static;
    inline-size: 273px;
    width: 273px;
    block-size: calc(750.75px * var(--panel-scale, 1));
    height: calc(750.75px * var(--panel-scale, 1));
    min-height: 0;
    margin: 0;
    margin-left: auto;
    margin-right: var(--acc-gap, 24px);
    align-self: flex-start;
    margin-top: clamp(10px, calc(62px * var(--panel-scale, 1)), 62px);
  }
  .accordion {
    position: absolute;
    top: var(--header-real-h, 70px);
    right: 90px;
    height: calc(100svh - var(--header-real-h, 70px));
    background: #ececec;
    border-left: 1px solid #000;
    z-index: 2;
  }
  .bottomSection {
    position: absolute;
    right: 0;
    --nav-scale: 1.5;
    --nav-size: 90px;
    --nav-gap: calc(10px * var(--nav-scale));
    --nav-track: calc(5px * var(--nav-scale));
    --nav-label-h: clamp(18px, calc(20px * min(var(--nav-scale), 1)), 32px);
    --nav-label-font: clamp(12px, calc(14px * min(var(--nav-scale), 1.1)), 20px);
    --nav-icon-target: calc(31px * var(--nav-scale));
    --nav-icon-max: calc(var(--nav-size) - var(--nav-track) - var(--nav-label-h) - 4px);
    --nav-icon-h: clamp(16px, min(var(--nav-icon-target), var(--nav-icon-max)), calc(var(--nav-size) * .68));
    --nav-icon-w: clamp(24px, calc(var(--nav-icon-h) * 1.35), calc(var(--nav-size) * .85));
    --nav-icon-gap: clamp(2px, calc(2px * var(--nav-scale)), 8px);
    top: var(--header-real-h, 71px);
    height: calc(100% - var(--header-real-h, 71px));
    width: var(--nav-size);
    border-top: none;
    border-left: 1px solid #000;
    margin-bottom: 0;
    justify-content: flex-start;
  }
  .bottomNav {
    width: var(--nav-size);
    height: min(639px, calc(100% - 19.5px));
    flex-direction: column;
    align-items: center;
    margin-top: 19.5px;
    overflow-y: auto;
  }
  .navIndicator { top: 0; bottom: 0; left: 0; right: auto; width: 5px; height: 100%; }
  .navButton { width: var(--nav-size); height: var(--nav-size); }
  .navButton:not(:first-child) { margin-left: 0; margin-top: 10px; }
}

@include s.respond(lg) { /* (po potrebi) */ }

@media (min-width: 600px) {
  .page [data-app-header] {
    height: 71px !important;
    min-height: 71px !important;
    padding-top: 0 !important;
    padding-bottom: 0 !important;
    align-items: center !important;
  }
  .page [data-app-header] > * {
    align-self: center !important;
  }
  .centralWrapper { background: #ADADAC; }
}

@media (min-width: 700px) and (max-width: 1023px) {
  .centralWrapper {
    position: relative;
  }
  
  .controlGroup {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: 10px; // ili koliko treba
  width: 410px;
  height: 60px;
  display: flex;
  justify-content: center;
  align-items: flex-end;
  z-index: 3;
  }

  .rotateleft,
  .rotateright {
    width: 60px !important;
    height: 60px !important;
    min-width: 60px !important;
    min-height: 60px !important;
    max-width: 60px !important;
    max-height: 60px !important;
  }

  .upload,
  .download {
    width: 50px !important;
    height: 50px !important;
    min-width: 50px !important;
    min-height: 50px !important;
    max-width: 50px !important;
    max-height: 50px !important;
  }

  .fullscreen {
    width: 40px !important;
    height: 40px !important;
    min-width: 40px !important;
    min-height: 40px !important;
    max-width: 40px !important;
    max-height: 40px !important;
  }
  .dataPanelWrapper {
    position: absolute !important;
    top: 10px !important;
    left: calc((10 / 430) * var(--page-w-px)) !important;
    inline-size: calc((180 / 430) * var(--page-w-px)) !important;
    block-size: min(
      calc((495 / 430) * var(--page-w-px)),
      100vh
    ) !important;
    height: min(
      calc((495 / 430) * var(--page-w-px)),
      100vh
    ) !important;
    z-index: 2 !important;
  }

  .bottomSection {
    --nav-scale: clamp(.75, calc(var(--page-w-px) / 430px), 1.5);
    --nav-size: calc(60px * var(--nav-scale));
  }

  .bottomNav {
    width: 100%;
    max-width: 100%;
    justify-content: center;
  }

  .navButton {
    width: var(--nav-size);
    height: var(--nav-size);
  }
}