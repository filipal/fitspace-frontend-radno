@use '../styles' as s;
$design-w: 430; // jedan izvor istine

@function cqw($px, $base: $design-w) {
  @return calc((#{$px} / #{$base}) * 100cqw); 
}

@function fsz($n, $minFactor: .85) {
  @return clamp(#{$n * $minFactor}px, cqw(#{$n}), #{$n}px);
}

:root {
  --design-w: #{$design-w};
  --design-h: 932;   /* visina dizajna (broj, bez px) */
  --header-h: 101;   /* visina headera (broj, bez px); stavi 0 ako ga nema */
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
}
.page {
  /* omogućuje cqw mjere u odnosu na širinu ove stranice */
  container-type: inline-size;
  position: relative;   /* ⟵ referenca za apsolutno pozicioniranje */
  width: 100%;
  max-width: calc(var(--design-w) * 1px);
  min-height: 100dvh;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  color: #000;
  background: #ececec;
  --page-w-px: 100cqw;
  container-name: page;
  /* nasljeđivanje fonta i na form-kontrole */
  button, input, select, textarea { font: inherit; }
}

.centralWrapper {
  --acc-h: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
  height: var(--avatar-h);
}

.withAccordion { --acc-h: cqw(171); }

.avatarSection {
  width: 100%;
  height: 100%;
  max-width: 100%;
  position: relative;
  display: flex;
  justify-content: center;
  align-items: flex-end;
  background: #ADADAC;
}

.avatarButton {
  inline-size: min(calc((30 / 430) * var(--page-w-px)), 30px);
  height: min(calc((19 / 430) * var(--page-w-px)), 19px);
  block-size: min(calc((19 / 430) * var(--page-w-px)), 19px);
  padding: 0;
  border: 0;
  background: transparent;
  display: grid;
  place-items: center;
  flex: 0 0 auto; /* ne rasteži u header flexu */
}
.avatarButton img{
  inline-size: 100%;
  block-size:  100%;
  object-fit: contain;
  display: block;
}

/* osiguraj minimalni tap-target na manjim širinama */
@container page (max-width: 400px){
  .avatarButton{
    min-inline-size: 28px;
    min-block-size:  28px;
  }
}

/* —— DATA PANEL POZICIJA I DIMENZIJE —— */
/* Wrapper određuje točnu kutiju 180×495 i poziciju 10/10 od stranice */
.dataPanelWrapper {
  position: absolute;
  /* 10px ispod headera (realna visina), skalirano po širini stranice */
  top: calc(
    var(--header-real-h, calc(var(--header-h, 0) * 1px))
    + (10 / 430) * var(--page-w-px)
  );
  left: calc((10 / 430) * var(--page-w-px));
  inline-size: calc((180 / 430) * var(--page-w-px));
  block-size:  calc((495 / 430) * var(--page-w-px));
  z-index: 2;
}

.bodySelected {
  height: min(var(--avatar-h), cqw(579));
  justify-content: flex-end;
}

@container page (max-width: 400px){
  .dataPanelWrapper{
    /* umjesto +10px (skalirano), koristi +6px (skalirano) */
    top: calc(var(--header-h, 0) * 1px + (-3 / 430) * var(--page-w-px));
    /* po želji: i lijevi odmak mrvu manji */
    /* left: calc((8 / 430) * var(--page-w-px)); */
  }
}

/* Background strip behind DataPanel when Body is selected */
.bodySelected::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  width: cqw(156);
  background: #BAB9BA;
  z-index: 0; /* stays behind DataPanel (which gets z-index:1) */
  pointer-events: none; /* do not block interactions */
}

.bodySelected .avatarImage {
  width: cqw(274);
  height: min(var(--avatar-h), cqw(579));
}

.avatarImage {
/*   width: 100%;
  height: 100%;
  object-fit: contain; */
  height: 100%;
  width: auto;
  max-width: 100%;
  object-fit: contain;
}

/* Face mode: show top-cropped/zoomed view at 430x670 */
.faceSelected {
  height: min(var(--avatar-h), cqw(670));
  --avatar-zoom: 2.4;
  overflow: hidden;
}

.faceSelected .avatarImage {
  width: 100%;
  height: 100%;
  object-fit: cover;
  object-position: top center;
  transform: scale(var(--avatar-zoom, 1));
  transform-origin: top center;
  will-change: transform;
}

/* Skin mode */
.skinSelected {
  height: min(var(--avatar-h), cqw(690));
  overflow: hidden;
  --avatar-zoom: 1.0;
  background: #BAB9BA;
}

.skinSelected .avatarImage {
  width: 100%;
  height: 100%;
  object-fit: contain; /* keep full body */
  transform: scale(var(--avatar-zoom, 1));
  transform-origin: center bottom;
}

/* Hair mode */
.hairSelected {
  height: min(var(--avatar-h), cqw(630));
  overflow: hidden;
  --avatar-zoom: 2.4;
}

.hairSelected .avatarImage {
  width: 100%;
  height: 100%;
  object-fit: cover; /* match Face behavior */
  object-position: top center; /* focus on the top area */
  transform: scale(var(--avatar-zoom, 1));
  transform-origin: top center;
  will-change: transform;
}

/* Extras mode */
.extrasSelected {
  height: min(var(--avatar-h), cqw(630));
  overflow: hidden;
  --avatar-zoom: 2.4;
}

.extrasSelected .avatarImage {
  width: 100%;
  height: 100%;
  object-fit: cover;
  object-position: top center;
  transform: scale(var(--avatar-zoom, 1));
  transform-origin: top center;
  will-change: transform;
}

.accordion {
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 0 !important;
  -webkit-text-size-adjust: none;
  text-size-adjust: none;
}

/* Kontrole ispod avatara */
.controlGroup {
  position: absolute;
  bottom: cqw(10);
  left: 50%;
  transform: translateX(-50%);
  width: cqw(410);
  height: cqw(60);
  display: flex;
  align-items: flex-end;
  z-index: 3;
}

.controlButton {
  position: relative;
  border: none;
  padding: 0;
  background: none;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: all 0.2s ease;
  color: #FFFFFF;
}
.controlButton svg { display: block; }
.controlButton svg .outerHalo { transition: fill .2s ease; }
.controlButton.selected svg .outerHalo { fill: #000; fill-opacity: 1; }
.controlButton svg .whiteRing { shape-rendering: geometricPrecision; }

.controlIcon {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

.controlButton .outerCircle { display: none; }
.controlButton.selected { color: #FFFFFF; }

.controlIcon { position: relative; z-index: 2; }
.outerCircle {
  position: absolute;
  inset: 0;
  border-radius: 50%;
  border: cqw(2) solid #FFFFFF;
  background: transparent;
  box-sizing: border-box;
  transition: border-color .25s ease;
  z-index: 1;
  pointer-events: none;
}
.controlButton.selected .outerCircle { border-color: #000; }

/* pojedinačne širine/razmaci ikona */
.rotateleft  { width: cqw(60); margin-right: cqw(50); }
.upload      { width: cqw(50); margin-right: cqw(25); }
.fullscreen  { width: cqw(40); margin-right: cqw(25); }
.download    { width: cqw(50); margin-right: cqw(50); }
.rotateright { width: cqw(60); }

/* Bottom nav sekcija */
.bottomSection {
  width: 100%;
  max-width: 430px;
  height: calc(cqw(60) + max(env(safe-area-inset-bottom, 0px), cqw(21)));
  border-top: 1px solid #000; /* border ostavi 1px zbog oštrine */
  display: flex;
  justify-content: center;
  align-items: flex-end;
  padding-top: 0; // Uklanja padding da border bude flush
  background: #ececec;
  position: relative;
}

.bottomNav {
  width: 100%;
  max-width: cqw(410);
  height: cqw(60);
  display: flex;
  align-self: flex-start; /* poravnaj uz gornji rub roditelja */
}

.navButton {
  width: cqw(60);
  height: cqw(60);
  padding: 0;
  border: none;
  background: none;
  /* -webkit-appearance: none;  iOS: ne bojaj tekst kao link/gumb */
  color: #000;              /* fiksiraj boju teksta na iOS-u */
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-end; // Poravnava sadržaj po dnu
  position: relative; // Allows absolute-positioned top indicator
}

.navButton:not(:first-child) {
  margin-left: cqw(10);
}

.navIndicator {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: cqw(5);
  display: none;
}

.active .navIndicator {
  background: #000;
  display: block;
}

.navIcon {
  display: flex;
  align-items: center;
  justify-content: center;
  max-height: cqw(35);
  order: 2; // Stavlja ikonu u sredinu
  margin-bottom: cqw(2);
}

.navIcon img {
  max-width: cqw(42);
  max-height: cqw(31);
  width: auto;
  height: auto;
}

.navLabel {
  height: cqw(20);
  font-size: clamp(12px, cqw(14), 16px);
  color: inherit;           /* naslijedi crnu iz .navButton */
  white-space: nowrap;      /* izbjegni lom teksta u širinu */
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;  /* zaštita od prelijevanja (crveni outline) */
  display: flex;
  align-items: center;
  justify-content: center;
  order: 3; // Stavlja label na dno
}

/* —— desktop layout ostaje kako je —— */
@include s.respond(xxl) {
  .page {
    width: 100vw;
    max-width: none;
    margin-left: calc(50% - 50vw);
    height: 100svh;
    align-items: flex-start;
    position: relative;
  }
  .centralWrapper {
    flex-direction: row;
    align-items: flex-start;
    justify-content: center;
    width: calc(100vw - 90px);
    height: calc(100vh - var(--header-real-h, 71px));
  }
  .centralWrapper.withAccordion { width: calc(100% - 90px - 335px); justify-content: flex-start; }
  .avatarShifted { margin-left: 123px; }
/*   .avatarSection { width: 604px; height: 953px; } */
  .avatarSection {
    max-width: 604px;
    height: 100%;
  }
  .controlGroup {
    width: 410px;
    height: 60px;
    bottom: 10px;
  }
  .rotateleft {
    width: 60px;
    height: 60px;
    margin-right: 50px;
  }
  .upload {
    width: 50px;
    height: 50px;
    margin-right: 25px;
  }
  .fullscreen {
    width: 40px;
    height: 40px;
    margin-right: 25px;
  }
  .download {
    width: 50px;
    height: 50px;
    margin-right: 50px;
  }
  .rotateright {
    width: 60px;
    height: 60px;
  }
  .outerCircle {
    border-width: 2px;
  }

  .bodySelected { height: min(var(--avatar-h), 953px); justify-content: center; }
  .bodySelected::before { display: none; }
  .bodySelected .avatarImage { width: 100%; height: 100%; max-height: var(--avatar-h); }
  .dataPanelWrapper { position: static; width: 273px; height: 774px; margin-left: 15px; margin-right: 22px; margin-top: 6
2px; }
  .accordion { width: 335px; height: calc(100% - 70px); position: absolute; top: 70px; right: 90px; }
  .bottomSection {
    position: absolute;
    right: 0;
    border-left: 1px solid #000; margin-bottom: 0; justify-content: flex-start;
    top: var(--header-real-h, 71px);
    height: calc(100% - var(--header-real-h, 71px));
    width: 90px;
    border-top: none;
    border-left: 1px solid #000;
    margin-bottom: 0;
    justify-content: flex-start;
  }
  .bottomNav {
    width: 90px;
    height: min(639px, calc(100% - 19.5px));
    flex-direction: column;
    align-items: center;
    margin-top: 19.5px;
    overflow-y: auto;
  }
  .navIndicator { top: 0; bottom: 0; left: 0; right: auto; width: 5px; height: 100%; }
  .navButton { width: 90px; height: 90px; }
  .navButton:not(:first-child) { margin-left: 0; margin-top: 10px; }
}

@include s.respond(lg) { /* (po potrebi) */ }

@media (min-width: 600px) {
  .page [data-app-header] {
    height: 71px !important;
    min-height: 71px !important;
    padding-top: 0 !important;
    padding-bottom: 0 !important;
    align-items: center !important;
  }
  .page [data-app-header] > * {
    align-self: center !important;
  }
  .centralWrapper { background: #ADADAC; }
}